<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>bolero.controller.controller &#8212; bolero 1.0.1-dev documentation</title>
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.1.0/flatly/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.1-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          bolero</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0.1-dev</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart-controller.html">Quick Start with the Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../behavior_learning.html">Behavior Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/representation.html">Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/optimizer.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/behavior_search.html">Behavior Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/environment.html">Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/controller.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/wrapper.html">Wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../imitation_learning.html">Imitation Learning</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">General examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#behavior-search-examples">Behavior search examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#dataset-examples">Dataset examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#environment-examples">Environment examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#optimizer-examples">Optimizer examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#representation-examples">Representation examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/index.html">Notebooks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_py.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_cpp.html">C++ API (Summary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/cpp_modules.html">All C++ Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mars_environment.html">MARS Environment</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<a href="https://github.com/rock-learning/bolero"><img style="position: absolute; top: 100; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <h1>Source code for bolero.controller.controller</h1><div class="highlight"><pre>
<span></span><span class="c1"># Author: Alexander Fabisch &lt;afabisch@informatik.uni-bremen.de&gt;</span>
<span class="c1">#         Jan Hendrik Metzen &lt;jhm@informatik.uni-bremen.de&gt;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">from_dict</span>
<span class="kn">from</span> <span class="nn">..utils.validation</span> <span class="k">import</span> <span class="n">check_feedback</span>
<span class="kn">from</span> <span class="nn">..environment</span> <span class="k">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">ContextualEnvironment</span>
<span class="kn">from</span> <span class="nn">..behavior_search</span> <span class="k">import</span> <span class="n">BehaviorSearch</span>
<span class="kn">from</span> <span class="nn">..base</span> <span class="k">import</span> <span class="n">Base</span>


<div class="viewcode-block" id="Controller"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.Controller.html#bolero.controller.Controller">[docs]</a><span class="k">class</span> <span class="nc">Controller</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A controller implements the communication between learning components.</span>

<span class="sd">    Controllers organize communication between Environment and BehaviorSearch.</span>
<span class="sd">    The code should neither depend on the environment nor on the behavior</span>
<span class="sd">    search algorithm so that we can reuse a controller for as many scenarios as</span>
<span class="sd">    possible.</span>

<span class="sd">    The controller subsection of the configuration dictionary may contain</span>
<span class="sd">    the following parameters:</span>

<span class="sd">    * n_episodes (int) - number of episodes that will be executed by</span>
<span class="sd">      :func:`learn`</span>
<span class="sd">    * record_inputs (bool) - store control signal trajectories (outputs</span>
<span class="sd">      of behaviors) of each episode in `self.inputs_`</span>
<span class="sd">    * record_outputs (bool) - store outputs of environment (inputs for</span>
<span class="sd">      behaviors) for each episode in `self.outputs_`</span>
<span class="sd">    * accumulate_feedbacks (bool) - log the sum of feedbacks (episode returns</span>
<span class="sd">      a scalar) or all feedbacks</span>
<span class="sd">    * record_contexts (bool) - store context vectors of each episode in</span>
<span class="sd">      `self.contexts_` (only available for contextual environments)</span>
<span class="sd">    * n_episodes_before_test (int) - the upper-level policy will be evaluated</span>
<span class="sd">      after `n_episodes_before_test` episodes</span>
<span class="sd">    * finish_after_convergence (bool) - finish the evaluation after either the</span>
<span class="sd">      environment or the behavior search reports convergence even though the</span>
<span class="sd">      maximum number of episodes might not be reached yet</span>
<span class="sd">    * verbose (bool) - print information to stdout</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : dict</span>
<span class="sd">        Configuration dictionary for the controller. The environment and the</span>
<span class="sd">        behavior search can either be specified in this dictionary or can</span>
<span class="sd">        be passed as arguments. In addition, parameters that configurate the</span>
<span class="sd">        controller can be passed here in the &#39;Controller&#39; subsection.</span>

<span class="sd">    environment : Environment</span>
<span class="sd">        Environment in which we will execute behaviors and learn</span>

<span class="sd">    behavior_search : BehaviorSearch, optional (default: None)</span>
<span class="sd">        Behavior search that evolves the behavior in the environment</span>

<span class="sd">    kwargs : dict</span>
<span class="sd">        Additional controller parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Controller.__init__"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.Controller.html#bolero.controller.Controller.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">behavior_search</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">from_dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="k">elif</span> <span class="s2">&quot;Environment&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;Environment&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Environment specification is missing.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">behavior_search</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="o">=</span> <span class="n">behavior_search</span>
        <span class="k">elif</span> <span class="s2">&quot;BehaviorSearch&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;BehaviorSearch&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_behavior_search</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;record_trajectories&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;record_trajectories is deprecated. Please use record_inputs.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;record_inputs&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specifying record_inputs and record_trajectories (deprecated) not allowed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config</span><span class="p">[</span><span class="s2">&quot;record_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;record_trajectories&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;record_inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;record_trajectories&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;n_episodes&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;record_inputs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;record_outputs&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;record_feedbacks&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;accumulate_feedbacks&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;n_episodes_before_test&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;finish_after_convergence&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_feedbacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feedbacks_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">episode_cnt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">do_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_episodes_before_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_results_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Initialized with&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             - </span><span class="si">%d</span><span class="s2"> inputs&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             - </span><span class="si">%d</span><span class="s2"> outputs&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__get_inputs_bw_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># just for backwards compatibility</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;property &#39;trajectories_&#39; is deprecated. Please use &#39;inputs_&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs_</span>
    <span class="n">trajectories_</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__get_inputs_bw_compatible</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;inputs to the environment (outputs of the behavior)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Controller&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; exists already as keyword argument &quot;</span>
                <span class="s2">&quot;(value: &#39;</span><span class="si">%s</span><span class="s2">&#39;) and overwrites &#39;</span><span class="si">%s</span><span class="s2">&#39; from configuration &quot;</span>
                <span class="s2">&quot;dictionary.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">value</span><span class="p">),</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_num_inputs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_num_outputs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_init_behavior_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Outputs of the environment are inputs for the behavior search</span>
            <span class="c1"># and vice versa</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check environment and behavior search.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">Environment</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Controller requires subclass of &#39;Environment&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="p">,</span> <span class="n">BehaviorSearch</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Controller requires subclass of &#39;BehaviorSearch&#39;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Controller.learn"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.Controller.html#bolero.controller.Controller.learn">[docs]</a>    <span class="k">def</span> <span class="nf">learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="o">=</span><span class="p">(),</span> <span class="n">meta_parameters</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Learn the behavior.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meta_parameter_keys : list</span>
<span class="sd">            Meta parameter keys</span>

<span class="sd">        meta_parameters : list</span>
<span class="sd">            Meta parameter values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        feedback_history : array, shape (n_episodes or less, dim_feedback)</span>
<span class="sd">            Feedbacks for each episode. If is_behavior_learning_done is True</span>
<span class="sd">            before the n_episodes is reached, the length of feedback_history</span>
<span class="sd">            is shorter than n_episodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feedback_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_episodes</span><span class="p">):</span>
            <span class="n">feedbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode</span><span class="p">(</span><span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">)</span>
            <span class="n">feedback_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feedbacks</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finish_after_convergence</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">is_behavior_learning_done</span><span class="p">()</span> <span class="ow">or</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_behavior_learning_done</span><span class="p">())):</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Terminated because of:</span><span class="se">\n</span><span class="s2">behavior_search: </span><span class="si">%s</span><span class="s2">, &quot;</span>
                  <span class="s2">&quot;environment: </span><span class="si">%s</span><span class="s2">&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">is_behavior_learning_done</span><span class="p">(),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_behavior_learning_done</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feedback_history</span><span class="p">)</span></div>

<div class="viewcode-block" id="Controller.episode"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.Controller.html#bolero.controller.Controller.episode">[docs]</a>    <span class="k">def</span> <span class="nf">episode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="o">=</span><span class="p">(),</span> <span class="n">meta_parameters</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Execute one learning episode.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meta_parameter_keys : array-like, shape = (n_meta_parameters,)</span>
<span class="sd">            Meta parameter keys</span>

<span class="sd">        meta_parameters : array-like, shape = (n_meta_parameters,)</span>
<span class="sd">            Meta parameter values</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        accumulated_feedback : float or array-like, shape = (n_feedbacks,)</span>
<span class="sd">            Feedback(s) of the episode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A BehaviorSearch is required to execute an &quot;</span>
                             <span class="s2">&quot;episode without specifying a behavior.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Episode: #</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">get_next_behavior</span><span class="p">()</span>
        <span class="n">feedbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_with</span><span class="p">(</span><span class="n">behavior</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="p">,</span>
                                      <span class="n">meta_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">set_evaluation_feedback</span><span class="p">(</span><span class="n">feedbacks</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accumulate_feedbacks</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Accumulated feedback: </span><span class="si">%g</span><span class="s2">&quot;</span>
                      <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feedbacks</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Feedbacks: </span><span class="si">%s</span><span class="s2">&quot;</span>
                      <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">array_str</span><span class="p">(</span><span class="n">feedbacks</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">episode_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_cnt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_episodes_before_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_results_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_perform_test</span><span class="p">(</span><span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">))</span>

        <span class="n">feedbacks</span> <span class="o">=</span> <span class="n">check_feedback</span><span class="p">(</span>
            <span class="n">feedbacks</span><span class="p">,</span> <span class="n">compute_sum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">accumulate_feedbacks</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">feedbacks</span></div>

<div class="viewcode-block" id="Controller.episode_with"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.Controller.html#bolero.controller.Controller.episode_with">[docs]</a>    <span class="k">def</span> <span class="nf">episode_with</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behavior</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="o">=</span><span class="p">[],</span>
                     <span class="n">meta_parameters</span><span class="o">=</span><span class="p">[],</span> <span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a behavior in the environment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        behavior : Behavior</span>
<span class="sd">            Fix behavior</span>

<span class="sd">        meta_parameter_keys : list, optional (default: [])</span>
<span class="sd">            Meta parameter keys</span>

<span class="sd">        meta_parameters : list, optional (default: [])</span>
<span class="sd">            Meta parameter values</span>

<span class="sd">        record : bool, optional (default: True)</span>
<span class="sd">            Record feedbacks or trajectories if activated</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        feedbacks : array, shape (n_steps,)</span>
<span class="sd">            Feedback for each step in the environment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">behavior</span><span class="o">.</span><span class="n">set_meta_parameters</span><span class="p">(</span><span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_outputs</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Sense initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">is_evaluation_done</span><span class="p">():</span>
            <span class="n">behavior</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">behavior</span><span class="o">.</span><span class="n">can_step</span><span class="p">():</span>
                <span class="n">behavior</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">behavior</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="c1"># Act</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">step_action</span><span class="p">()</span>
            <span class="c1"># Sense</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_inputs</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_outputs</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">feedbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_feedback</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_feedbacks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feedbacks_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feedbacks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feedbacks</span></div>

    <span class="k">def</span> <span class="nf">_perform_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">):</span>
        <span class="n">behavior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">get_best_behavior</span><span class="p">()</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_with</span><span class="p">(</span>
            <span class="n">behavior</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">))</span>
        <span class="n">optimum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_maximum_feedback</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Test feedback: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">performance</span> <span class="o">-</span> <span class="n">optimum</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">performance</span> <span class="o">-</span> <span class="n">optimum</span></div>


<div class="viewcode-block" id="ContextualController"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.ContextualController.html#bolero.controller.ContextualController">[docs]</a><span class="k">class</span> <span class="nc">ContextualController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Controller for contextual problems.</span>

<span class="sd">    See base class &quot;Controller&quot; for details on usage.</span>

<span class="sd">    The controller subsection of the configuration dictionary may contain</span>
<span class="sd">    the following additional parameters:</span>

<span class="sd">    * test_contexts (array-like) - the upper-level policy will be evaluated in</span>
<span class="sd">      these contexts</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ContextualController.__init__"><a class="viewcode-back" href="../../../modules/generated/bolero.controller.ContextualController.html#bolero.controller.ContextualController.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{},</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">behavior_search</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ContextualController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">behavior_search</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;record_contexts&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_attribute</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;test_contexts&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_contexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contexts_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_test</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_contexts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide &#39;test_contexts&#39; if &quot;</span>
                                 <span class="s2">&quot;&#39;n_episodes_before_tests&#39; is not None.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             - </span><span class="si">%d</span><span class="s2"> context dimensions&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_context_dims</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_behavior_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_context_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_num_context_dims</span><span class="p">()</span>
            <span class="c1"># Outputs of the environment are inputs for the behavior search</span>
            <span class="c1"># and vice versa</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_inputs</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">n_context_dims</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">ContextualEnvironment</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ContextualController requires contextual &quot;</span>
                            <span class="s2">&quot;environment!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="p">,</span> <span class="n">BehaviorSearch</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ContextualController requires contextual &quot;</span>
                            <span class="s2">&quot;behavior search!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_negotiate_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Negotiate context.&quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">get_desired_context</span><span class="p">()</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_contexts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contexts_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span> <span class="nf">episode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="o">=</span><span class="p">(),</span> <span class="n">meta_parameters</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A ContextualBehaviorSearch is required to &quot;</span>
                             <span class="s2">&quot;execute an episode without specifying a &quot;</span>
                             <span class="s2">&quot;behavior.&quot;</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_negotiate_context</span><span class="p">()</span>

        <span class="n">accumulated_feedback</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ContextualController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">episode</span><span class="p">(</span>
            <span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Controller] Context: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">accumulated_feedback</span>

    <span class="k">def</span> <span class="nf">_perform_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">):</span>
        <span class="n">behavior_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior_search</span><span class="o">.</span><span class="n">get_best_behavior_template</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_contexts</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">context</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_contexts</span><span class="p">):</span>
            <span class="n">actual_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">actual_context</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Evaluation is not possible, could not set &quot;</span>
                                <span class="s2">&quot;context.&quot;</span><span class="p">)</span>
            <span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior_template</span><span class="o">.</span><span class="n">get_behavior</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="c1"># TODO what happens if we do not know the optimum?</span>
            <span class="n">optimum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_maximum_feedback</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">episode_with</span><span class="p">(</span>
                <span class="n">behavior</span><span class="p">,</span> <span class="n">meta_parameter_keys</span><span class="p">,</span> <span class="n">meta_parameters</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimum</span> <span class="o">-</span> <span class="n">current</span>
        <span class="k">return</span> <span class="n">results</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014-2018, DFKI GmbH / Robotics Innovation Center, University of Bremen / Robotics Group.<br/>
      Last updated on May 26, 2018.<br/>
    </p>
  </div>
</footer>
  </body>
</html>